
@{
    ViewBag.Title = "Users List";
}

<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        Master
        <small>Data Pengguna</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="/"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">Data Pengguna</li>
    </ol>
</section>
<!-- Main content -->
<section class="content">
    <div id="data-list" class="box">
        <div class="box-header with-border">
            <h3 class="box-title">List Buku</h3>
            <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip"
                        title="Collapse">
                    <i class="fa fa-minus"></i>
                </button>
                <button type="button" class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="Remove">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>
        <div class="box-body">
            <div id="grid-users"></div>
        </div>
        <!-- /.box-body -->
        <div class="box-footer text-right">
            <button id="btn-add" type="button" class="btn btn-primary"><i class="fa fa-plus"></i> Tambah Baru</button>
        </div>
        <!-- /.box-footer-->
    </div>
    <!-- /.box -->
    <div id="data-detail" class="box" style="display: none">
        <form name="form1" enctype="multipart/form-data">
            <div class="box-header with-border">
                <h3 class="box-title">Detail Pengguna</h3>
                <div class="box-tools pull-right">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip"
                            title="Collapse">
                        <i class="fa fa-minus"></i>
                    </button>
                    <button type="button" class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="Remove">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="box-body">
                <div class="form-horizontal">
                    <div class="form-group">
                        <div class="col-md-2 control-label">UserName </div>
                        <div class="col-md-3">
                            <input data-bind="UserName" type="text" name="UserName" class="form-control" required />
                            <input data-bind="UserID" type="hidden" name="UserID" class="form-control" />
                            <input data-bind="CreatedBy" type="hidden" name="CreatedBy" class="form-control" />
                            <input data-bind="CreatedAt" type="hidden" name="CreatedAt" class="form-control" />
                            <input data-bind="ModifiedBy" type="hidden" name="ModifiedBy" class="form-control" />
                            <input data-bind="ModifiedAt" type="hidden" name="ModifiedAt" class="form-control" />
                        </div>
                        <div class="col-md-2 control-label">Nama Lengkap </div>
                        <div class="col-md-3">
                            <input data-bind="FullName" type="text" name="FullName" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-2 control-label">Tanggal Lahir </div>
                        <div class="col-md-3">
                            <input type="date" data-bind="DateOfBirth" name="DateOfBirth" class="form-control" />
                        </div>
                        <div class="col-md-2 control-label">Jenis Kelamin </div>
                        <div class="col-md-3">
                            <select name="Gender" class="form-control" data-bind='Gender' required>
                                <option>--Pilih Jenis Kelamin--</option>
                                <option value="Laki-Laki">Laki-Laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-2 control-label">Kata Sandi </div>
                        <div class="col-md-3">
                            <input data-bind="Password" type="Password" name="Password" class="form-control" />
                        </div>
                        <div class="col-md-2 control-label">Nomor Telepon </div>
                        <div class="col-md-3">
                            <input data-bind="PhoneNumber" type="tel" name="PhoneNumber" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-2 control-label">Foto </div>
                        <div class="col-md-3">
                            <input data-bind="Img" type="file" name="Img" class="form-control" accept="image/png, image/jpeg"/>
                            <input data-bind="ImgName" type="hidden" name="ImgName" />
                        </div>
                        <div class="col-md-2 control-label">Status </div>
                        <div class="col-md-3">
                            <select name="Status" class="form-control" data-bind="Status" required>
                                <option>--Pilih Status--</option>
                                <option value="1">Show</option>
                                <option value="0">Hide</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-5 text-right">
                            <img src="" class="img-responsive img-thumbnail" alt="Foto Profil" id="foto" width="150px"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-2 control-label">Role </div>
                        <div class="col-md-3">
                            <select name="Role" class="form-control" data-bind="Role" required>
                                <option>--Pilih Role--</option>
                                <option value="Admin">Admin</option>
                                <option value="Super Admin">Super Admin</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="box-footer text-center">
                <button id="btn-back" type="button" class="btn btn-default"><i class="fa fa-chevron-left"></i> Back</button>
                <button id="btn-save" type="button" class="btn btn-primary"><i class="fa fa-save"></i> Save</button>
            </div>
        </form>
    </div>
</section>
<!-- /.content-->
@section scripts
{
    <script>
        (function () {
            function Users() {
                return {
                    UserID: null,
                    UserName: '',
                    FullName: '',
                    DateOfBirth: '',
                    Gender: '',
                    Password: '',
                    PhoneNumber: '',
                    Img: null,
                    ImgName: '',
                    Status: true,
                    Role: '',
                    RegisterDate: '',
                    LastModifiedDate: '',
                }
            }

            var scope = (function () {
                return Bind({
                    user: new Users()
                }, {
                    "user.UserID": "[data-bind='UserID']",
                    "user.UserName": "[data-bind='UserName']",
                    "user.FullName": "[data-bind='FullName']",
                    //"student.Gender": "[data-bind='Gender']",
                    "user.DateOfBirth": "[data-bind='DateOfBirth']",
                    "user.Password": "[data-bind='Password']",
                    "user.PhoneNumber": "[data-bind='PhoneNumber']",
                    //"user.Img": "[data-bind='Img']",
                    "user.ImgName": "[data-bind='ImgName']",
                });
            }());

            var gridUsers = gridview("grid-users", {
                url: "/Users/Paging",
                columns: [
                    {
                        text: "", render: function (c) {
                            var tmpl = "<a action='view'><i class='fa fa-search'></i></a>";
                            tmpl += "<a action='edit'><i class='fa fa-edit'></i></a>";
                            tmpl += "<a action='remove'><i class='fa fa-trash'></i></a>";
                            return tmpl;
                        }
                    },
                    { field: "UserName", text: "UserName", sortable: true },
                    { field: "FullName", text: "Nama Lengkap", sortable: true },
                    { field: "Gender", text: "Jenis Kelamin", sortable: true },
                    { field: "DateOfBirth", text: "Tanggal Lahir", sortable: true },
                    { field: "PhoneNumber", text: "No.Telp", sortable: true },
                    { field: "Status", text: "Status", sortable: true },
                    { field: "Role", text: "Role", sortable: true },
                    { field: "RegisterDate", text: "Dibuat Pada", sortable: true },
                    { field: "LastModifiedDate", text: "Terakhir Diubah Pada", sortable: true }
                ],
                fieldKey: "UserID",
                view: view,
                edit: edit,
                remove: remove
            });

            function getBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            $("[data-bind='Gender']").on("change", function () {
                scope.user.Gender = $(this).val();
            });

            $("[data-bind='Role']").on("change", function () {
                scope.user.Role = $(this).val();
            });

            $("[data-bind='Status']").on("change", function () {
                var a = parseInt($(this).val());
                scope.user.Status = Boolean(a);
                //console.log(scope.category);
            });

            $("[data-bind='Img']").on("change", function () {
                var file = document.querySelector('input[type="file"]').files[0];
                getBase64(file).then(
                    function (data) {
                        scope.user.Img = data.toString().replace("data:" + file.type + ";base64,", "");
                        scope.user.ImgName = file.name;
                        $("#foto").attr("src", data).show();
                        $("[data-bind='ImgName']").val(file.name);
                        console.log(scope);
                    }
                );
            });

            var state = "new";

            function view(usr) {
                var textStats = usr.Status == true ? "1" : "0";
                var file = document.querySelector("[type='file']");
                let typeFile = usr.ImgName != "" || usr.ImgName != null ? usr.ImgName.split(".")[1] : null;
                scope.user = usr;
                showDetail();
                if (usr.Img != null) {
                    $("#foto").attr({
                        "src": "data:image/" + typeFile + ";base64," + usr.Img
                    }).show();
                } else {
                    $("#foto").attr("src", "").hide();
                }
                file.value = "";
                $("[data-bind='Gender']").val(usr.Gender);
                $("[data-bind='Role']").val(usr.Role);
                $("[data-bind='Status']").val(textStats);
                $("[data-bind]").attr("disabled", true);
                $("#btn-save").hide();
            }

            function edit(usr) {
                state = "update";
                let textStats = usr.Status == true ? "1" : "0";
                var file = document.querySelector("[type='file']");
                let typeFile = usr.ImgName != "" || usr.ImgName != null? usr.ImgName.split(".")[1] : null;
                scope.user = usr;
                showDetail();
                if (usr.Img != null) {
                    $("#foto").attr({
                        "src": "data:image/" + typeFile +";base64," + usr.Img
                    }).show();
                } else {
                    $("#foto").attr("src", "").hide();
                }
                file.value = "";
                $("[data-bind='Gender']").val(usr.Gender);
                $("[data-bind='Role']").val(usr.Role);
                $("[data-bind='Status']").val(textStats);
                $("[data-bind]").attr("disabled", false);
                $("[data-bind='StudentID']").attr("disabled", true);
                $("#btn-save").show();
            }

            function addNew() {
                state = "new";
                scope.user = new Users();
                var file = document.querySelector("[type='file']");
                showDetail();
                $("#foto").attr("src", "").hide();
                file.value = "";
                $("[data-bind='ImgName']").val("");
                $("[data-bind='Gender']").val("--Pilih Jenis Kelamin--");
                $("[data-bind='Role']").val("--Pilih Role--");
                $("[data-bind]").attr("disabled", false);
                $("#btn-save").show();
            }

            function remove(usr) {
                Swal.fire({
                    title: "Confirmation",
                    text: "Are you sure?",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonText: "YES",
                    cancelButtonText: "NO",
                    confirmButtonColor: "red"
                })
                    .then(function (r) {
                        if (r.value) {
                            axios.post("/Users/Delete", { id: usr.UserID })
                                .then(function (res) { return res.data; }, function (err) { console.log("Err: ", er); })
                                .then(function (res) {
                                    if (res.meta.success) {
                                        Swal.fire("Success", "Delete data success", "success")
                                            .then(function (r) {
                                                gridUsers.reload();
                                            });
                                    } else {
                                        Swal.fire("Error", res.meta.message, "error");
                                    }
                                });
                        }
                    })
            }

            function showDetail() {
                $("#data-list").fadeOut(250, function () { $("#data-detail").fadeIn(500) });
            }

            function showList() {
                $("#data-detail").fadeOut(250, function () { $("#data-list").fadeIn(500) });
            }

            function save() {
                var url = "/Users/" + (state === "new" ? "Insert" : "Update");
                axios.post(url, { user: scope.user })
                    .then(function (res) { return res.data; }, function (err) { console.log("Err: ", er); })
                    .then(function (res) {
                        if (res.meta.success) {
                            Swal.fire("Success", "Save data success", "success")
                                .then(function (r) {
                                    showList();
                                    gridUsers.reload();
                                });
                        } else {
                            Swal.fire("Error", res.meta.message, "error");
                        }
                    });
            }

            $("#btn-add").click(addNew);
            $("#btn-back").click(function () { showList(); });
            $("#btn-save").click(save);

        }());
    </script>
}